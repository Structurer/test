<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è¯èƒŒè¯µåŠ©æ‰‹ï¼ˆæ‹¼å†™éªŒè¯ç‰ˆï¼‰</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="main-container">
        <!-- å·¦ä¾§å•è¯åˆ—è¡¨åŒº -->
        <div class="left-section" id="leftScrollArea">
            <h1>ğŸ“š å•è¯èƒŒè¯µåŠ©æ‰‹</h1>
            
            <div class="control-bar">
                <button class="btn" id="hideBtn" disabled>éšè—æ‰€æœ‰é‡Šä¹‰</button>
                <button class="btn" id="showBtn" disabled>æ˜¾ç¤ºæ‰€æœ‰é‡Šä¹‰</button>
                <button class="btn reset" id="shuffleBtn" disabled>éšæœºæ‰“ä¹±é¡ºåº</button>
                <span class="word-count" id="count">å…± <span>0</span> ä¸ªå•è¯</span>
            </div>

            <!-- åŠ è½½æç¤ºå®¹å™¨ï¼ˆåˆå§‹æ˜¾ç¤ºï¼ŒåŠ è½½ä¸­é€æ­¥æ›¿æ¢ï¼‰ -->
            <div class="word-list" id="wordList">
                <div style="text-align: center; padding: 80px 20px; color: #4299e1; font-size: 20px; line-height: 2;">
                    â³ æ­£åœ¨åŠ è½½å•è¯æ•°æ®...<br>
                    è¯·ç¨å€™ï¼ŒåŠ è½½å®Œæˆåè‡ªåŠ¨æ˜¾ç¤ºå¡ç‰‡
                </div>
            </div>
        </div>

        <!-- å³ä¾§è¾“å…¥åŒº -->
        <div class="right-section">
            <div class="input-container">
                <div class="input-title">âœï¸ æ‹¼å†™å•è¯</div>
                <input type="text" class="word-input" id="wordInput" placeholder="åŠ è½½å®Œæˆåå¯è¾“å…¥" disabled>
                <div class="feedback" id="feedback">ğŸ“Œ ç­‰å¾…æ•°æ®åŠ è½½ä¸­...</div>
                <div class="progress" id="progress">åŠ è½½æœŸé—´åˆ¤æ–­ç¨æ…¢ï¼š0/0</div> <!-- å®æ—¶æ˜¾ç¤ºâ€œå·²åŠ è½½/æ€»æ•°é‡â€ -->
                <button class="btn" id="nextBtn" disabled>ä¸‹ä¸€ä¸ªå•è¯</button>
            </div>
        </div>
    </div>

    <script>
        let words = [];
        let currentIndex = 0;
        let shuffledWords = [];
        const leftScrollArea = document.getElementById('leftScrollArea');
        let isAutoScroll = false;
        let scrollTimeout = null;
        let enterClickCount = 0;
        let enterTimeout = null;
        const correctDelay = 750;
        let totalWordCount = 0; // æ€»å•è¯æ•°
        let loadedWordCount = 0; // å·²åŠ è½½å•è¯æ•°
        const progressEl = document.getElementById('progress'); // ç¼“å­˜è¿›åº¦DOMï¼Œé¿å…é‡å¤æŸ¥è¯¢
        const BATCH_UPDATE_COUNT = 10; // æ¯åŠ è½½10ä¸ªæ›´æ–°ä¸€æ¬¡ï¼ˆæ›´é¢‘ç¹ï¼Œè§†è§‰ä¸Šæ›´å®æ—¶ï¼‰

        // åŠ è½½JSONæ–‡ä»¶
        fetch('Vocabulary.json')
            .then(response => {
                if (!response.ok) throw new Error('æ–‡ä»¶è®¿é—®å¤±è´¥');
                return response.json();
            })
            .then(data => {
                words = data;
                shuffledWords = [...words];
                totalWordCount = words.length; // ç»Ÿè®¡æ€»å•è¯æ•°
                const countSpan = document.querySelector('#count span');
                countSpan.textContent = totalWordCount;
                
                // åˆå§‹åŒ–è¿›åº¦æ˜¾ç¤ºï¼ˆ0/æ€»æ•°é‡ï¼‰
                progressEl.textContent = `åŠ è½½ä¸­ï¼š0/${totalWordCount}`;

                // æ¸²æŸ“å•è¯å¡ç‰‡ï¼ˆå®æ—¶æ›´æ–°åŠ è½½è¿›åº¦ï¼Œå¼ºåˆ¶DOMå“åº”ï¼‰
                renderWordsWithProgress(shuffledWords);
                // æ¿€æ´»ç¬¬ä¸€ä¸ªå•è¯
                activateCurrentWord();
                // ç»‘å®šäº‹ä»¶+å¯ç”¨æ‰€æœ‰æ§ä»¶
                bindEvents();
                enableAllControls();
            })
            .catch(error => {
                // åŠ è½½å¤±è´¥æç¤ºï¼ˆ2æ¡æ ¸å¿ƒæ£€æŸ¥é¡¹ï¼‰
                document.getElementById('wordList').innerHTML = `
                    <div style="text-align: center; padding: 80px 20px; color: #e53e3e; font-size: 18px; line-height: 2.2;">
                        âŒ å•è¯æ•°æ®åŠ è½½å¤±è´¥ï¼<br><br>
                        è¯·æ£€æŸ¥ï¼š<br>
                        1. Vocabulary.json æ–‡ä»¶æ˜¯å¦åœ¨åŒæ–‡ä»¶å¤¹<br>
                        2. æ˜¯å¦é€šè¿‡ HTTP åè®®æ‰“å¼€é¡µé¢ï¼ˆæœ¬åœ° file:// åè®®ä¸æ”¯æŒè·¨æ–‡ä»¶è¯»å–ï¼‰<br>
                    </div>
                `;
                document.getElementById('feedback').textContent = 'âŒ åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°æ¡ä»¶';
                document.getElementById('feedback').className = 'feedback error';
                progressEl.textContent = 'åŠ è½½å¤±è´¥';
            });

        // æ ¸å¿ƒï¼šå¸¦å®æ—¶è¿›åº¦çš„å•è¯æ¸²æŸ“ï¼ˆå¼ºåˆ¶DOMå³æ—¶æ›´æ–°ï¼‰
        function renderWordsWithProgress(wordArray) {
            const wordList = document.getElementById('wordList');
            wordList.innerHTML = ''; // æ¸…ç©ºåˆå§‹æç¤º
            const fragment = document.createDocumentFragment();

            // åˆ†æ‰¹æ¬¡æ¸²æŸ“ï¼Œæ¯æ‰¹æ¸²æŸ“BATCH_UPDATE_COUNTä¸ªï¼Œæ¸²æŸ“å®Œä¸€æ‰¹æ›´æ–°è¿›åº¦+å¼ºåˆ¶DOMåˆ·æ–°
            const renderBatch = (startIndex) => {
                const endIndex = Math.min(startIndex + BATCH_UPDATE_COUNT - 1, wordArray.length - 1);
                
                for (let i = startIndex; i <= endIndex; i++) {
                    const wordObj = wordArray[i];
                    const card = document.createElement('div');
                    card.className = `word-card ${i === currentIndex ? 'active' : ''}`;
                    card.dataset.index = i;

                    // ä¸­æ–‡æ„æ€+ç´§è·Ÿè¯æ€§
                    let translationsHtml = '<div class="translations-container">';
                    wordObj.translations.forEach(trans => {
                        const meanings = trans.translation.split('ï¼›');
                        meanings.forEach(mean => {
                            translationsHtml += `
                                <div class="translation-item">
                                    <span class="meaning">${mean.trim()}</span>
                                    <span class="pos-tag">${trans.type}</span>
                                </div>
                            `;
                        });
                    });
                    translationsHtml += '</div>';

                    // å¸¸ç”¨çŸ­è¯­
                    let phrasesHtml = '';
                    if (wordObj.phrases && wordObj.phrases.length > 0) {
                        phrasesHtml = `
                            <div class="phrases-title">å¸¸ç”¨çŸ­è¯­ï¼š</div>
                            <div class="phrase-list">
                                ${wordObj.phrases.map(phrase => `
                                    <div class="phrase-item">
                                        <span class="phrase-eng">${phrase.phrase}</span>
                                        <span class="phrase-cn">${phrase.translation}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }

                    card.innerHTML = `
                        <div class="word-header">
                            <div class="word">${wordObj.word}</div>
                        </div>
                        ${translationsHtml}
                        ${phrasesHtml}
                    `;

                    // é‡Šä¹‰æ˜¾ç¤º/éšè—äº‹ä»¶
                    const transItems = card.querySelectorAll('.translation-item');
                    transItems.forEach(el => {
                        el.addEventListener('click', () => el.classList.toggle('hidden'));
                    });

                    fragment.appendChild(card);
                    loadedWordCount++;
                }

                // æ’å…¥å½“å‰æ‰¹æ¬¡çš„å¡ç‰‡
                wordList.appendChild(fragment);
                // æ›´æ–°è¿›åº¦ï¼Œå¹¶å¼ºåˆ¶æµè§ˆå™¨å³æ—¶æ¸²æŸ“ï¼ˆå…³é”®ä¿®å¤ï¼‰
                progressEl.textContent = `åŠ è½½æœŸé—´åˆ¤æ–­ç¨æ…¢ï¼š${loadedWordCount}/${totalWordCount}`;
                progressEl.offsetHeight; // å¼ºåˆ¶DOMå›æµï¼Œç¡®ä¿è¿›åº¦å³æ—¶æ˜¾ç¤º

                // å¦‚æœè¿˜æœ‰æœªæ¸²æŸ“çš„å•è¯ï¼Œç»§ç»­æ¸²æŸ“ä¸‹ä¸€æ‰¹
                if (endIndex < wordArray.length - 1) {
                    requestAnimationFrame(() => renderBatch(endIndex + 1)); // ç”¨åŠ¨ç”»å¸§è°ƒåº¦ï¼Œé¿å…å¡é¡¿
                } else {
                    // æ‰€æœ‰å•è¯æ¸²æŸ“å®Œæˆï¼Œåˆ‡æ¢ä¸ºèƒŒè¯µè¿›åº¦
                    progressEl.textContent = `è¿›åº¦ï¼š1/${totalWordCount}`;
                }
            };

            // å¼€å§‹åˆ†æ‰¹æ¬¡æ¸²æŸ“
            renderBatch(0);
        }

        // å¯ç”¨æ‰€æœ‰äº¤äº’æ§ä»¶ï¼ˆåŠ è½½å®Œæˆåï¼‰
        function enableAllControls() {
            document.getElementById('wordInput').disabled = false;
            document.getElementById('nextBtn').disabled = false;
            document.getElementById('hideBtn').disabled = false;
            document.getElementById('showBtn').disabled = false;
            document.getElementById('shuffleBtn').disabled = false;
            document.getElementById('wordInput').placeholder = 'è¾“å…¥å•è¯æŒ‰å›è½¦éªŒè¯ï¼ŒåŒå‡»å›è½¦è·³è¿‡';
            document.getElementById('feedback').textContent = '';
        }

        // æ¿€æ´»å½“å‰å•è¯
        function activateCurrentWord() {
            const cards = document.querySelectorAll('.word-card');
            if (!cards[currentIndex]) return;

            isAutoScroll = true;
            cards.forEach((card, index) => card.classList.toggle('active', index === currentIndex));
            cards[currentIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });

            document.getElementById('wordInput').value = '';
            document.getElementById('feedback').textContent = '';
            enterClickCount = 0;

            setTimeout(() => isAutoScroll = false, 500);
        }

        // æ›´æ–°èƒŒè¯µè¿›åº¦æ˜¾ç¤º
        function updateProgress() {
            progressEl.textContent = `è¿›åº¦ï¼š${currentIndex + 1}/${totalWordCount}`;
        }

        // éªŒè¯è¾“å…¥
        function validateInput() {
            const inputEl = document.getElementById('wordInput');
            const feedbackEl = document.getElementById('feedback');
            const inputValue = inputEl.value.trim().toLowerCase();
            const currentWord = shuffledWords[currentIndex].word.toLowerCase();

            if (inputValue === currentWord) {
                feedbackEl.textContent = 'âœ… æ‹¼å†™æ­£ç¡®ï¼';
                feedbackEl.className = 'feedback correct';
                setTimeout(goToNextWord, correctDelay);
            } else {
                feedbackEl.textContent = 'âŒ æ‹¼å†™é”™è¯¯ï¼Œå†è¯•è¯•ï¼';
                feedbackEl.className = 'feedback error';
                inputEl.select();
            }
        }

        // ä¸‹ä¸€ä¸ªå•è¯
        function goToNextWord() {
            if (currentIndex < totalWordCount - 1) {
                currentIndex++;
            } else {
                document.getElementById('feedback').textContent = 'ğŸ‰ æ‰€æœ‰å•è¯èƒŒè¯µå®Œæˆï¼';
                document.getElementById('feedback').className = 'feedback correct';
                setTimeout(() => {
                    currentIndex = 0;
                    activateCurrentWord();
                    updateProgress();
                }, 1500);
                return;
            }
            activateCurrentWord();
            updateProgress();
        }

        // æŸ¥æ‰¾å±…ä¸­å•è¯ç´¢å¼•
        function findCenteredWordIndex() {
            const cards = document.querySelectorAll('.word-card');
            const scrollAreaRect = leftScrollArea.getBoundingClientRect();
            const centerY = scrollAreaRect.top + scrollAreaRect.height / 2;
            let closestIndex = currentIndex;
            let minDistance = Infinity;

            cards.forEach((card, index) => {
                const cardCenterY = card.getBoundingClientRect().top + card.getBoundingClientRect().height / 2;
                const distance = Math.abs(cardCenterY - centerY);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestIndex = index;
                }
            });

            return closestIndex;
        }

        // ç»‘å®šæ‰€æœ‰äº‹ä»¶
        function bindEvents() {
            const inputEl = document.getElementById('wordInput');
            const nextBtn = document.getElementById('nextBtn');
            const hideBtn = document.getElementById('hideBtn');
            const showBtn = document.getElementById('showBtn');
            const shuffleBtn = document.getElementById('shuffleBtn');

            // å›è½¦äº‹ä»¶
            inputEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    enterClickCount++;

                    if (enterClickCount === 2) {
                        clearTimeout(enterTimeout);
                        document.getElementById('feedback').textContent = 'â­ï¸ è·³è¿‡å½“å‰å•è¯';
                        setTimeout(goToNextWord, 300);
                        enterClickCount = 0;
                    }

                    if (enterClickCount === 1) {
                        enterTimeout = setTimeout(() => {
                            const inputValue = inputEl.value.trim();
                            inputValue ? validateInput() : document.getElementById('feedback').textContent = 'ğŸ’¡ åŒå‡»å›è½¦å¯è·³è¿‡';
                            enterClickCount = 0;
                        }, 250);
                    }
                }
            });

            // æŒ‰é’®äº‹ä»¶
            nextBtn.addEventListener('click', goToNextWord);
            hideBtn.addEventListener('click', () => document.querySelectorAll('.translation-item').forEach(el => el.classList.add('hidden')));
            showBtn.addEventListener('click', () => document.querySelectorAll('.translation-item').forEach(el => el.classList.remove('hidden')));

            // æ‰“ä¹±å•è¯ï¼ˆé‡æ–°åŠ è½½è¿›åº¦ï¼‰
            shuffleBtn.addEventListener('click', () => {
                shuffledWords = [...words].sort(() => Math.random() - 0.5);
                currentIndex = 0;
                loadedWordCount = 0; // é‡ç½®åŠ è½½è®¡æ•°
                document.getElementById('wordList').innerHTML = `
                    <div style="text-align: center; padding: 80px 20px; color: #4299e1; font-size: 18px;">
                        â³ æ­£åœ¨æ‰“ä¹±å•è¯é¡ºåº...
                    </div>
                `;
                disableAllControls();
                progressEl.textContent = `åŠ è½½ä¸­ï¼š0/${totalWordCount}`;

                setTimeout(() => {
                    renderWordsWithProgress(shuffledWords);
                    activateCurrentWord();
                    updateProgress();
                    enableAllControls();
                }, 300);
            });

            // æ»šåŠ¨äº‹ä»¶
            leftScrollArea.addEventListener('scroll', () => {
                if (isAutoScroll) return;
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const centeredIndex = findCenteredWordIndex();
                    if (centeredIndex !== currentIndex) {
                        currentIndex = centeredIndex;
                        document.querySelectorAll('.word-card').forEach((card, index) => card.classList.toggle('active', index === currentIndex));
                        updateProgress();
                        document.getElementById('wordInput').value = '';
                        document.getElementById('feedback').textContent = '';
                        enterClickCount = 0;
                    }
                }, 300);
            });
        }

        // ä¸´æ—¶ç¦ç”¨æ§ä»¶ï¼ˆæ‰“ä¹±æ—¶ç”¨ï¼‰
        function disableAllControls() {
            document.getElementById('wordInput').disabled = true;
            document.getElementById('nextBtn').disabled = true;
            document.getElementById('feedback').textContent = 'ğŸ“Œ æ­£åœ¨æ‰“ä¹±...';
        }
    </script>
</body>
</html>