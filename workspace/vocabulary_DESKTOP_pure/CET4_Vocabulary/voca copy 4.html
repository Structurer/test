<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è¯èƒŒè¯µåŠ©æ‰‹ï¼ˆæ‹¼å†™éªŒè¯ç‰ˆï¼‰</title>
    <!-- å·²å•ç‹¬å¼•å…¥CSSï¼Œæ­¤å¤„æ— éœ€é‡å¤ -->
    <link rel="stylesheet" href="styles.css"> <!-- æ›¿æ¢ä¸ºä½ çš„CSSæ–‡ä»¶è·¯å¾„/åç§° -->
</head>
<body>
    <div class="main-container">
        <!-- å·¦ä¾§å•è¯åˆ—è¡¨åŒº -->
        <div class="left-section" id="leftScrollArea">
            <h1>ğŸ“š å•è¯èƒŒè¯µåŠ©æ‰‹</h1>
            
            <div class="control-bar">
                <button class="btn" id="hideBtn">éšè—æ‰€æœ‰é‡Šä¹‰</button>
                <button class="btn" id="showBtn">æ˜¾ç¤ºæ‰€æœ‰é‡Šä¹‰</button>
                <button class="btn reset" id="shuffleBtn">éšæœºæ‰“ä¹±é¡ºåº</button>
                <span class="word-count" id="count">å…± <span>0</span> ä¸ªå•è¯</span>
            </div>

            <div class="word-list" id="wordList"></div>
        </div>

        <!-- å³ä¾§è¾“å…¥éªŒè¯åŒº -->
        <div class="right-section">
            <div class="input-container">
                <div class="input-title">âœï¸ æ‹¼å†™å•è¯</div>
                <input type="text" class="word-input" id="wordInput" placeholder="è¾“å…¥å·¦ä¾§å½“å‰å•è¯ï¼ŒæŒ‰å›è½¦éªŒè¯">
                <div class="feedback" id="feedback"></div>
                <div class="progress" id="progress">è¿›åº¦ï¼š0/0</div>
                <button class="btn" id="nextBtn">ä¸‹ä¸€ä¸ªå•è¯</button>
            </div>
        </div>
    </div>

    <script>
        let words = [];
        let currentIndex = 0; // å½“å‰èƒŒè¯µå•è¯ç´¢å¼•
        let shuffledWords = []; // æ‰“ä¹±åçš„å•è¯æ•°ç»„
        const leftScrollArea = document.getElementById('leftScrollArea');
        let isAutoScroll = false; // æ ‡è®°æ˜¯å¦æ˜¯ç¨‹åºè‡ªåŠ¨æ»šåŠ¨ï¼ˆé¿å…ä¸æ‰‹åŠ¨æ»šåŠ¨å†²çªï¼‰
        let scrollTimeout = null; // æ»šåŠ¨é˜²æŠ–è®¡æ—¶å™¨

        // åŠ è½½JSONæ–‡ä»¶ï¼ˆæ ¸å¿ƒï¼šè¯»å–åŒæ–‡ä»¶å¤¹ä¸‹çš„Vocabulary.jsonï¼‰
        fetch('Vocabulary.json')
            .then(response => {
                if (!response.ok) throw new Error('JSONæ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®è®¤æ–‡ä»¶å­˜åœ¨ä¸”è·¯å¾„æ­£ç¡®');
                return response.json();
            })
            .then(data => {
                words = data;
                shuffledWords = [...words]; // åˆå§‹ä¸åŸæ•°ç»„ä¸€è‡´ï¼Œæ‰“ä¹±åæ›´æ–°
                const countSpan = document.querySelector('#count span');
                countSpan.textContent = words.length;
                updateProgress();

                // æ¸²æŸ“å•è¯å¡ç‰‡
                renderWords(shuffledWords);
                // æ¿€æ´»ç¬¬ä¸€ä¸ªå•è¯ï¼ˆå±…ä¸­+é«˜äº®ï¼‰
                activateCurrentWord();
                // ç»‘å®šæ‰€æœ‰äº¤äº’äº‹ä»¶
                bindEvents();
            })
            .catch(error => {
                document.getElementById('wordList').innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #e53e3e;">
                        âŒ ${error.message}
                    </div>
                `;
            });

        // æ¸²æŸ“æ‰€æœ‰å•è¯å¡ç‰‡ï¼ˆæ”¯æŒå¤šè¯æ€§/å¤šé‡Šä¹‰åˆ†è¡Œå±•ç¤ºï¼‰
        function renderWords(wordArray) {
            const wordList = document.getElementById('wordList');
            wordList.innerHTML = '';
            wordArray.forEach((wordObj, index) => {
                const card = document.createElement('div');
                card.className = `word-card ${index === currentIndex ? 'active' : ''}`;
                card.dataset.index = index;

                // ä¸­æ–‡æ„æ€+ç´§è·Ÿè¯æ€§ï¼ˆæ¯è¡Œä¸€ä¸ªæ„æ€+è¯æ€§ï¼Œé¿å…ç«–å‘è¿‡é•¿ï¼‰
                let translationsHtml = '<div class="translations-container">';
                wordObj.translations.forEach(trans => {
                    const meanings = trans.translation.split('ï¼›'); // æŒ‰åˆ†å·æ‹†åˆ†å¤šé‡Šä¹‰
                    meanings.forEach(mean => {
                        translationsHtml += `
                            <div class="translation-item">
                                <span class="meaning">${mean.trim()}</span>
                                <span class="pos-tag">${trans.type}</span>
                            </div>
                        `;
                    });
                });
                translationsHtml += '</div>';

                // æ¸²æŸ“å¸¸ç”¨çŸ­è¯­ï¼ˆè‹¥æœ‰ï¼‰
                let phrasesHtml = '';
                if (wordObj.phrases && wordObj.phrases.length > 0) {
                    phrasesHtml = `
                        <div class="phrases-title">å¸¸ç”¨çŸ­è¯­ï¼š</div>
                        <div class="phrase-list">
                            ${wordObj.phrases.map(phrase => `
                                <div class="phrase-item">
                                    <span class="phrase-eng">${phrase.phrase}</span>
                                    <span class="phrase-cn">${phrase.translation}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // å¡ç‰‡å®Œæ•´HTML
                card.innerHTML = `
                    <div class="word-header">
                        <div class="word">${wordObj.word}</div>
                    </div>
                    ${translationsHtml}
                    ${phrasesHtml}
                `;

                // ç‚¹å‡»é‡Šä¹‰é¡¹åˆ‡æ¢æ˜¾ç¤º/éšè—
                const transItems = card.querySelectorAll('.translation-item');
                transItems.forEach(el => {
                    el.addEventListener('click', () => {
                        el.classList.toggle('hidden');
                    });
                });

                wordList.appendChild(card);
            });
        }

        // æ¿€æ´»å½“å‰å•è¯ï¼ˆé«˜äº®+ç«–å‘å±…ä¸­æ»šåŠ¨ï¼‰
        function activateCurrentWord() {
            const cards = document.querySelectorAll('.word-card');
            if (!cards[currentIndex]) return;

            isAutoScroll = true; // æ ‡è®°ä¸ºç¨‹åºè‡ªåŠ¨æ»šåŠ¨ï¼Œé¿å…è§¦å‘æ‰‹åŠ¨æ»šåŠ¨é€»è¾‘

            // é«˜äº®å½“å‰å•è¯ï¼Œå–æ¶ˆå…¶ä»–å¡ç‰‡é«˜äº®
            cards.forEach((card, index) => {
                card.classList.toggle('active', index === currentIndex);
            });

            // æ»šåŠ¨åˆ°å½“å‰å•è¯å¹¶ç«–å‘å±…ä¸­
            cards[currentIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });

            // æ¸…ç©ºè¾“å…¥æ¡†å’Œåé¦ˆä¿¡æ¯
            document.getElementById('wordInput').value = '';
            document.getElementById('feedback').textContent = '';
            document.getElementById('feedback').className = 'feedback';

            // è‡ªåŠ¨æ»šåŠ¨ç»“æŸåé‡ç½®æ ‡è®°ï¼ˆåŒ¹é…æ»šåŠ¨åŠ¨ç”»æ—¶é•¿ï¼‰
            setTimeout(() => {
                isAutoScroll = false;
            }, 500);
        }

        // æ›´æ–°è¿›åº¦æ˜¾ç¤ºï¼ˆå¦‚ï¼šè¿›åº¦ï¼š3/10ï¼‰
        function updateProgress() {
            const progressEl = document.getElementById('progress');
            progressEl.textContent = `è¿›åº¦ï¼š${currentIndex + 1}/${shuffledWords.length}`;
        }

        // éªŒè¯è¾“å…¥çš„å•è¯æ˜¯å¦æ­£ç¡®
        function validateInput() {
            const inputEl = document.getElementById('wordInput');
            const feedbackEl = document.getElementById('feedback');
            const inputValue = inputEl.value.trim().toLowerCase();
            const currentWord = shuffledWords[currentIndex].word.toLowerCase();

            if (inputValue === currentWord) {
                feedbackEl.textContent = 'âœ… æ‹¼å†™æ­£ç¡®ï¼';
                feedbackEl.className = 'feedback correct';
                // å»¶è¿Ÿ0.5ç§’è‡ªåŠ¨è·³è½¬åˆ°ä¸‹ä¸€ä¸ªå•è¯
                setTimeout(() => {
                    goToNextWord();
                }, 500);
            } else {
                feedbackEl.textContent = 'âŒ æ‹¼å†™é”™è¯¯ï¼Œå†è¯•è¯•ï¼';
                feedbackEl.className = 'feedback error';
                inputEl.select(); // é€‰ä¸­è¾“å…¥å†…å®¹ï¼Œæ–¹ä¾¿é‡æ–°è¾“å…¥
            }
        }

        // è·³è½¬åˆ°ä¸‹ä¸€ä¸ªå•è¯
        function goToNextWord() {
            if (currentIndex < shuffledWords.length - 1) {
                currentIndex++;
            } else {
                // æ‰€æœ‰å•è¯èƒŒè¯µå®Œæˆï¼Œæç¤ºåé‡ç½®åˆ°ç¬¬ä¸€ä¸ª
                document.getElementById('feedback').textContent = 'ğŸ‰ æ‰€æœ‰å•è¯èƒŒè¯µå®Œæˆï¼';
                document.getElementById('feedback').className = 'feedback correct';
                setTimeout(() => {
                    currentIndex = 0;
                    activateCurrentWord();
                    updateProgress();
                }, 1500);
                return;
            }
            activateCurrentWord();
            updateProgress();
        }

        // æŸ¥æ‰¾å½“å‰è§†å›¾ç«–å‘å±…ä¸­çš„å•è¯ç´¢å¼•ï¼ˆæ‰‹åŠ¨æ»šåŠ¨æ—¶ç”¨ï¼‰
        function findCenteredWordIndex() {
            const cards = document.querySelectorAll('.word-card');
            const scrollAreaRect = leftScrollArea.getBoundingClientRect();
            const centerY = scrollAreaRect.top + scrollAreaRect.height / 2; // è§†å›¾ä¸­å¿ƒYåæ ‡
            let closestIndex = currentIndex;
            let minDistance = Infinity;

            // éå†æ‰€æœ‰å¡ç‰‡ï¼Œæ‰¾åˆ°è·ç¦»è§†å›¾ä¸­å¿ƒæœ€è¿‘çš„å•è¯
            cards.forEach((card, index) => {
                const cardRect = card.getBoundingClientRect();
                const cardCenterY = cardRect.top + cardRect.height / 2;
                const distance = Math.abs(cardCenterY - centerY);

                if (distance < minDistance) {
                    minDistance = distance;
                    closestIndex = index;
                }
            });

            return closestIndex;
        }

        // ç»‘å®šæ‰€æœ‰äº¤äº’äº‹ä»¶
        function bindEvents() {
            const inputEl = document.getElementById('wordInput');
            const nextBtn = document.getElementById('nextBtn');
            const hideBtn = document.getElementById('hideBtn');
            const showBtn = document.getElementById('showBtn');
            const shuffleBtn = document.getElementById('shuffleBtn');

            // è¾“å…¥æ¡†æŒ‰å›è½¦éªŒè¯å•è¯
            inputEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    validateInput();
                }
            });

            // ç‚¹å‡»"ä¸‹ä¸€ä¸ªå•è¯"æŒ‰é’®è·³è½¬
            nextBtn.addEventListener('click', goToNextWord);

            // éšè—æ‰€æœ‰é‡Šä¹‰
            hideBtn.addEventListener('click', () => {
                document.querySelectorAll('.translation-item').forEach(el => el.classList.add('hidden'));
            });

            // æ˜¾ç¤ºæ‰€æœ‰é‡Šä¹‰
            showBtn.addEventListener('click', () => {
                document.querySelectorAll('.translation-item').forEach(el => el.classList.remove('hidden'));
            });

            // éšæœºæ‰“ä¹±å•è¯é¡ºåºï¼ˆé‡ç½®å½“å‰ç´¢å¼•åˆ°ç¬¬ä¸€ä¸ªï¼‰
            shuffleBtn.addEventListener('click', () => {
                shuffledWords = [...words].sort(() => Math.random() - 0.5);
                currentIndex = 0;
                renderWords(shuffledWords);
                activateCurrentWord();
                updateProgress();
            });

            // æ ¸å¿ƒï¼šæ‰‹åŠ¨æ»šåŠ¨å·¦ä¾§åˆ—è¡¨æ—¶ï¼Œè‡ªåŠ¨é€‰ä¸­å±…ä¸­å•è¯
            leftScrollArea.addEventListener('scroll', () => {
                // å¿½ç•¥ç¨‹åºè‡ªåŠ¨æ»šåŠ¨çš„æƒ…å†µ
                if (isAutoScroll) return;

                // é˜²æŠ–å¤„ç†ï¼šé¿å…æ»šåŠ¨æ—¶é¢‘ç¹è§¦å‘ï¼ˆæ»šåŠ¨åœæ­¢å0.3ç§’æ‰§è¡Œï¼‰
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const centeredIndex = findCenteredWordIndex();
                    if (centeredIndex !== currentIndex) {
                        currentIndex = centeredIndex;
                        // é«˜äº®æ–°çš„å±…ä¸­å•è¯ï¼Œä¸è§¦å‘æ»šåŠ¨ï¼ˆé¿å…å¾ªç¯ï¼‰
                        const cards = document.querySelectorAll('.word-card');
                        cards.forEach((card, index) => {
                            card.classList.toggle('active', index === currentIndex);
                        });
                        // æ›´æ–°è¿›åº¦å’Œè¾“å…¥æ¡†
                        updateProgress();
                        document.getElementById('wordInput').value = '';
                        document.getElementById('feedback').textContent = '';
                    }
                }, 300);
            });
        }
    </script>
</body>
</html>